package dcap

import (
	"encoding/hex"
	"testing"

	"github.com/stretchr/testify/require"
)

func TestParseDCAPVerifierCommit(t *testing.T) {
	input, err := hex.DecodeString("00000003000000000500906ed50000a1acc73eb45794fa1734f14d882e91925b6006f79d3bb2460df9d01b333d700900000000679842ef0000000067bfc78b15150b07ff800e000000000000000000000000000000000000000000000000000000000000000000000000000000000005000000000000000700000000000000813c146e403f203f2784fa222b3edeac70727dee21c0b08f74883aa189e7b0ed000000000000000000000000000000000000000000000000000000000000000083d719e77deaca1470f6baf62a4d774303c899db69020f9c70ee1dfc08c7ce9e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000019f097bb8083709d28251b036fc75d5f91e9a0ecf000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000e494e54454c2d53412d3030333334000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e494e54454c2d53412d3030363135000000000000000000000000000000000000")
	require.NoError(t, err)
	commit, err := ParseDCAPVerifierCommit(input)
	require.NoError(t, err)
	require.EqualValues(t, 0, commit.Version)
	require.EqualValues(t, 3, commit.QuoteVersion)
	require.EqualValues(t, 0, commit.TeeType)
	require.EqualValues(t, SWHardeningNeeded, commit.TcbStatus)
	require.EqualValues(t, []byte{0, 144, 110, 213, 0, 0}, commit.Fmspc)
	expectedMrEnclave, _ := hex.DecodeString("813c146e403f203f2784fa222b3edeac70727dee21c0b08f74883aa189e7b0ed")
	require.EqualValues(t, expectedMrEnclave, commit.QuoteBody.AsEnclaveIdentity().MrEnclave)
	reportData, _ := hex.DecodeString("019f097bb8083709d28251b036fc75d5f91e9a0ecf00000000000000000000000000000000000000000000000000000000000000000000000000000000000000")
	require.EqualValues(t, reportData, commit.ReportData(), hex.EncodeToString(commit.ReportData()))
	require.Len(t, commit.AdvisoryIds, 2)
	require.EqualValues(t, []string{"INTEL-SA-00334", "INTEL-SA-00615"}, commit.AdvisoryIds)
	require.EqualValues(t, commit.SGXIntelRootCAHash, HashTrustRootCert())

	require.EqualValues(t, input, commit.ToBytes())
}
